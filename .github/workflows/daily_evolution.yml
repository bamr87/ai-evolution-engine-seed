---
# AI Evolution Workflow - Daily Growth Maintenance
# Version: 0.4.7
# Last Updated: 2025-07-21
# 
# Purpose: Automated daily improvements and maintenance for the AI-seed ecosystem
# This workflow performs routine evolutionary maintenance to keep the seed healthy and growing

name: ðŸŒ± Daily Evolution & Maintenance (v0.4.7)

on:
  schedule:
    # Run daily at 3 AM UTC - optimal growth time
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      evolution_type:
        description: 'Type of daily evolution to run'
        required: false
        default: 'consistency'
        type: choice
        options:
          - consistency      # Fix inconsistencies across files and configurations
          - error_fixing     # Resolve errors, bugs, and issues
          - documentation    # Improve documentation quality and coverage
          - code_quality     # Enhance code quality, patterns, and standards
          - security_updates # Apply security improvements and updates
      intensity:
        description: 'Evolution intensity level'
        required: false
        default: 'minimal'
        type: choice
        options:
          - minimal         # Small, safe changes with low risk
          - moderate        # Medium-sized improvements with moderate risk
          - comprehensive   # Large-scale improvements with higher impact
      force_run:
        description: 'Force run even if no changes detected'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Run in simulation mode without making actual changes'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  EVOLUTION_VERSION: "0.4.7"
  WORKFLOW_TYPE: "scheduled_evolution"

jobs:
  daily_evolution:
    name: ðŸŒ¿ Daily Growth & Maintenance
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      EVOLUTION_TYPE: ${{ github.event.inputs.evolution_type || 'consistency' }}
      INTENSITY: ${{ github.event.inputs.intensity || 'minimal' }}
      FORCE_RUN: ${{ github.event.inputs.force_run || 'false' }}
      DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
    
    steps:
      - name: ðŸŒ± Prepare Evolution Environment
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}
          ref: evolved
          
      - name: ðŸ› ï¸ Setup Environment
        run: |
          set -euo pipefail
          if [ ! -f "./scripts/setup-environment.sh" ]; then
            echo "âŒ Setup script not found!"
            exit 1
          fi
          chmod +x ./scripts/setup-environment.sh
          ./scripts/setup-environment.sh
          
      - name: ðŸ” Validate Prerequisites
        run: |
          set -euo pipefail
          
          # Validate required files exist
          required_files=("./scripts/setup-environment.sh")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Required file missing: $file"
              exit 1
            fi
          done
          
          # Validate environment variables
          required_vars=("EVOLUTION_VERSION" "WORKFLOW_TYPE")
          for var in "${required_vars[@]}"; do
            if [ -z "${!var:-}" ]; then
              echo "âŒ Required environment variable missing: $var"
              exit 1
            fi
          done
          
          echo "âœ… All prerequisites validated"

      - name: ðŸ“Š Collect Evolution Context
        run: |
          set -euo pipefail
          
          echo "ðŸ“Š Collecting repository context for evolution..."
          
          # Collect basic repository metrics
          echo "Repository State Analysis:" > /tmp/evolution-context.txt
          echo "=========================" >> /tmp/evolution-context.txt
          echo "Commit Count: $(git rev-list --count HEAD)" >> /tmp/evolution-context.txt
          echo "Branch: $(git branch --show-current)" >> /tmp/evolution-context.txt
          echo "Last Commit: $(git log -1 --format='%h %s')" >> /tmp/evolution-context.txt
          echo "Files Changed (last 7 days): $(git log --since='7 days ago' --name-only --pretty=format: | sort | uniq | wc -l)" >> /tmp/evolution-context.txt
          echo "" >> /tmp/evolution-context.txt
          
          # File structure analysis
          echo "File Structure:" >> /tmp/evolution-context.txt
          echo "Source files: $(find src/ -name '*.js' -o -name '*.py' -o -name '*.jsx' 2>/dev/null | wc -l || echo 0)" >> /tmp/evolution-context.txt
          echo "Test files: $(find tests/ -name '*.test.*' 2>/dev/null | wc -l || echo 0)" >> /tmp/evolution-context.txt
          echo "Documentation files: $(find docs/ -name '*.md' 2>/dev/null | wc -l || echo 0)" >> /tmp/evolution-context.txt
          echo "Workflow files: $(find .github/workflows/ -name '*.yml' -o -name '*.yaml' 2>/dev/null | wc -l || echo 0)" >> /tmp/evolution-context.txt
          
          echo "âœ… Context collection completed"
          
      - name: ðŸ“Š Analyze Repository Health
        id: health_check
        run: |
          set -euo pipefail
          chmod +x ./scripts/analyze-repository-health-simple.sh
          ./scripts/analyze-repository-health-simple.sh \
            "$EVOLUTION_TYPE" \
            "$INTENSITY" \
            "$FORCE_RUN"
          
          # Load results for GitHub Actions output
          if [ -f "/tmp/health_check_results.env" ]; then
            source /tmp/health_check_results.env
            echo "issues_found=${ISSUES_FOUND:-0}" >> $GITHUB_OUTPUT
            echo "should_evolve=${SHOULD_EVOLVE:-false}" >> $GITHUB_OUTPUT
          fi
          
          # Format suggestions for GitHub Actions
          if [ -f "/tmp/health_check_suggestions.txt" ]; then
            {
              echo 'suggestions<<EOF'
              cat /tmp/health_check_suggestions.txt
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi

      - name: ðŸ§¬ Generate Evolution Prompt
        id: generate_prompt
        if: steps.health_check.outputs.should_evolve == 'true'
        run: |
          set -euo pipefail
          chmod +x ./scripts/generate-evolution-prompt.sh
          ./scripts/generate-evolution-prompt.sh \
            "$EVOLUTION_TYPE" \
            "$INTENSITY"
          
          # Load the generated prompt for GitHub Actions output
          if [ -f "/tmp/evolution_prompt.txt" ]; then
            {
              echo 'evolution_prompt<<EOF'
              cat /tmp/evolution_prompt.txt
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi

      - name: ðŸš€ Trigger Evolution Workflow
        if: steps.health_check.outputs.should_evolve == 'true' && env.DRY_RUN != 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          set -euo pipefail
          chmod +x ./scripts/trigger-evolution-workflow.sh
          
          # Trigger the main evolution workflow with target branch set to 'evolved'
          ./scripts/trigger-evolution-workflow.sh \
            "$EVOLUTION_TYPE" \
            "conservative" \
            "evolved"

      - name: ðŸ” Dry Run - Preview Evolution
        if: steps.health_check.outputs.should_evolve == 'true' && env.DRY_RUN == 'true'
        run: |
          set -euo pipefail
          echo "ðŸ” DRY RUN MODE - Evolution that would be triggered:"
          echo "Evolution Type: $EVOLUTION_TYPE"
          echo "Intensity: $INTENSITY"
          echo "Suggestions:"
          if [ -f "/tmp/health_check_suggestions.txt" ]; then
            cat /tmp/health_check_suggestions.txt
          fi
          
          # Show what would be changed
          if git diff --name-only 2>/dev/null | head -10; then
            echo ""
            echo "Files that would be modified:"
            git diff --name-only | head -10
          else
            echo "No changes would be made with current settings."
          fi

      - name: ðŸ“Š Generate Evolution Report
        if: steps.health_check.outputs.should_evolve == 'true'
        run: |
          set -euo pipefail
          
          echo "ðŸ“Š Generating evolution report..."
          
          report_file="/tmp/evolution-report.md"
          cat > "$report_file" << EOF
          # Daily Evolution Report
          
          **Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          **Evolution Type**: $EVOLUTION_TYPE
          **Intensity**: $INTENSITY
          **Dry Run**: $DRY_RUN
          
          ## Changes Applied
          
          $(if [ "$DRY_RUN" = "true" ]; then
            echo "No changes applied - dry run mode"
          else
            echo "Evolution changes applied successfully"
          fi)
          
          ## Repository Health
          
          - Total commits: $(git rev-list --count HEAD)
          - Active branch: $(git branch --show-current)
          - Last activity: $(git log -1 --format='%cr')
          - Issues found: ${ISSUES_FOUND:-0}
          
          ## Next Evolution
          
          The next daily evolution will occur at 3 AM UTC tomorrow.
          EOF
          
          echo "âœ… Evolution report generated at $report_file"
          if [ -f "$report_file" ]; then
            cat "$report_file"
          fi

      - name: ðŸ“Š Update Daily Evolution Metrics
        if: steps.health_check.outputs.should_evolve == 'true' && env.DRY_RUN != 'true'
        run: |
          set -euo pipefail
          chmod +x ./scripts/update-evolution-metrics.sh
          ./scripts/update-evolution-metrics.sh
          
          # Also create metrics summary
          metrics_file="/tmp/growth-metrics.json"
          cat > "$metrics_file" << EOF
          {
            "timestamp": "$(date -Iseconds)",
            "workflow": "daily-evolution",
            "evolution_type": "$EVOLUTION_TYPE",
            "intensity": "$INTENSITY",
            "dry_run": $DRY_RUN,
            "success": ${{ job.status == 'success' }},
            "repository": {
              "commits": $(git rev-list --count HEAD),
              "files": $(find . -type f 2>/dev/null | wc -l || echo 0),
              "size_mb": $(du -sm . 2>/dev/null | cut -f1 || echo 0)
            }
          }
          EOF
          
          echo "Growth metrics recorded in $metrics_file"

      - name: ðŸŒ± No Evolution Needed
        if: steps.health_check.outputs.should_evolve == 'false'
        run: |
          echo "ðŸŒ± Repository health check complete - no evolution needed"
          echo "âœ… Repository is in good health!"
          echo "ðŸ”„ Next automated check will run tomorrow at 3 AM UTC"
          echo ""
          echo "To force an evolution cycle, run:"
          echo "  gh workflow run daily_evolution.yml -f force_run=true"

      - name: ðŸ”„ Error Recovery
        if: failure()
        run: |
          set -euo pipefail
          
          echo "âŒ Daily evolution failed - attempting recovery"
          
          # Log error context
          echo "Current directory: $(pwd)"
          echo "Git status: $(git status --porcelain || echo 'Git status failed')"
          echo "Environment variables: $(env | grep -E '^(EVOLUTION|WORKFLOW)_' || echo 'No evolution vars')"
          
          # Attempt cleanup
          if [ -d "/tmp" ]; then
            echo "Cleaning temporary files..."
            find /tmp -name "*evolution*" -type f -delete 2>/dev/null || true
          fi
          
          echo "ðŸ”„ Recovery attempt completed"

      - name: ðŸ“‹ Collect Workflow Errors & Warnings
        if: always()
        id: error_collection
        run: |
          set -euo pipefail
          chmod +x ./scripts/collect-workflow-errors.sh
          ./scripts/collect-workflow-errors.sh \
            --workflow-type "daily_evolution" \
            --job-status "${{ job.status }}" \
            --collect-from-logs \
            --include-context
          
          echo "âœ… Daily evolution cycle completed"
